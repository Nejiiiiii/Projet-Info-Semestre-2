<?php
// Définir le chemin vers le fichier CSV
$chemin = 'data/utilisateurs.csv';

// Vérifier si le dossier "data" existe, sinon le créer
if (!file_exists('data')) {
    mkdir('data', 0777, true);
}

// Fonction pour ajouter un nouvel utilisateur dans le CSV
function ajouterUtilisateur($utilisateur, $chemin) {
    $handle = fopen($chemin, 'a');
    if ($handle !== false) {
        fputcsv($handle, $utilisateur);
        fclose($handle);
        return true;
    }
    return false;
}

// Initialiser un message de confirmation
$message = '';

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Récupérer les données du formulaire et définir les champs requis
    $login = trim($_POST['login']);
    $motDePasse = trim($_POST['motDePasse']); // En production, pensez à hacher ce mot de passe.
    $role = trim($_POST['role']);
    $nom = trim($_POST['nom']);
    $prenom = trim($_POST['prenom']);
    $dateNaissance = trim($_POST['dateNaissance']);
    $adresse = trim($_POST['adresse']);

    // Pour simplifier, on définit la date d'inscription et la dernière connexion à la date courante
    $dateInscription = date('c');
    $derniereConnexion = date('c');
    
    // Champs pour voyages (pour l'instant vides, on pourra utiliser un séparateur comme ";" pour plusieurs ids)
    $voyagesConsultes = '';
    $voyagesAchetes = '';

    // Créer un tableau représentant l'utilisateur à ajouter
    $nouvelUtilisateur = [
        $login,
        $motDePasse,
        $role,
        $nom,
        $prenom,
        $dateNaissance,
        $adresse,
        $dateInscription,
        $derniereConnexion,
        $voyagesConsultes,
        $voyagesAchetes
    ];
    
    // Si le fichier CSV n'existe pas, on écrit d'abord l'en-tête
    if (!file_exists($chemin)) {
        $handle = fopen($chemin, 'w');
        $header = ['login', 'motDePasse', 'role', 'nom', 'prenom', 'dateNaissance', 'adresse', 'dateInscription', 'derniereConnexion', 'voyagesConsultes', 'voyagesAchetes'];
        fputcsv($handle, $header);
        fclose($handle);
    }
    
    // Ajouter l'utilisateur dans le fichier CSV
    if (ajouterUtilisateur($nouvelUtilisateur, $chemin)) {
        $message = "Nouvel utilisateur ajouté avec succès.";
    } else {
        $message = "Erreur lors de l'ajout de l'utilisateur.";
    }
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Utilisateurs - CSV</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .form-container { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .message { color: green; }
    </style>
</head>
<body>
    <h1>Ajouter un Utilisateur</h1>
    <?php if ($message != '') { echo '<p class="message">'.$message.'</p>'; } ?>
    <div class="form-container">
        <form action="" method="post">
            <label for="login">Login :</label><br>
            <input type="text" id="login" name="login" required><br><br>
            
            <label for="motDePasse">Mot de passe :</label><br>
            <input type="password" id="motDePasse" name="motDePasse" required><br><br>
            
            <label for="role">Rôle :</label><br>
            <select id="role" name="role">
                <option value="normal">Normal</option>
                <option value="administrateur">Administrateur</option>
            </select><br><br>
            
            <label for="nom">Nom :</label><br>
            <input type="text" id="nom" name="nom" required><br><br>
            
            <label for="prenom">Prénom :</label><br>
            <input type="text" id="prenom" name="prenom" required><br><br>
            
            <label for="dateNaissance">Date de naissance :</label><br>
            <input type="date" id="dateNaissance" name="dateNaissance" required><br><br>
            
            <label for="adresse">Adresse :</label><br>
            <input type="text" id="adresse" name="adresse" required><br><br>
            
            <button type="submit">Ajouter l'utilisateur</button>
        </form>
    </div>
    
    <h2>Liste des Utilisateurs</h2>
    <?php
    // Lecture du fichier CSV et affichage de la liste des utilisateurs
    if (file_exists($chemin)) {
        $handle = fopen($chemin, "r");
        if ($handle !== false) {
            echo '<table>';
            $ligne = 0;
            while (($data = fgetcsv($handle, 1000, ",")) !== false) {
                // Afficher l'en-tête dans la première ligne
                if ($ligne == 0) {
                    echo '<tr>';
                    foreach ($data as $entete) {
                        echo '<th>' . htmlspecialchars($entete) . '</th>';
                    }
                    echo '</tr>';
                } else {
                    echo '<tr>';
                    foreach ($data as $champ) {
                        echo '<td>' . htmlspecialchars($champ) . '</td>';
                    }
                    echo '</tr>';
                }
                $ligne++;
            }
            echo '</table>';
            fclose($handle);
        } else {
            echo "<p>Erreur lors de l'ouverture du fichier.</p>";
        }
    } else {
        echo "<p>Aucun utilisateur n'a encore été ajouté.</p>";
    }
    ?>
</body>
</html>
